<script lang="ts" setup>
import contentPanels from '~/components/layoutSections/contentPanels.vue';
import type { CheckboxGroupItem, CheckboxGroupValue, InputMenuItem, } from '@nuxt/ui'
import { ref } from 'vue';

import { db, type Role } from "~/assets/scripts/db";
import { liveQuery } from 'dexie';
import { useObservable } from "@vueuse/rxjs";
import { from } from "rxjs";

import { useSettingsStore } from '~/stores/settings'
const settings = useSettingsStore()
const allRoles = useObservable<Role[] | undefined>(from(liveQuery(async () => await db.roles.toArray())));

const items = computed(() => {
  return allRoles.value?.filter((role) => {
    return activeRole.value.includes(role.type);
  }).map((role) => ({
    date: `${settings.months[role.startDate.getMonth() ?? 0]?.substring(0, 3) ?? ''} ${role.startDate.getFullYear()}`,
    title: role.name,
    description: role.description || 'No description available',
    icon: role.type == 'jobs' ? 'i-lucide-briefcase-business' :
      role.type == 'education' ? 'i-lucide-backpack' :
        role.type == 'volunteering' ? 'i-lucide-handbag' :
          role.type == 'events' ? 'i-lucide-ticket-check' :
            role.type == 'projects' ? 'i-lucide-chart-gantt' :
              'i-lucide-activity',
    to: `/experience/${role.id}`
  })) || []
});

const roles = ref<CheckboxGroupItem[]>([
  {
    label: 'Jobs',
    value: 'jobs',
    description: 'A paid position of regular employment'
  },
  {
    label: 'Education',
    value: 'education',
    description: 'Formal learning experiences, degrees, and certifications'
  },
  {
    label: 'Volunteering',
    value: 'volunteering',
    description: 'Unpaid work for the community or charitable organizations'
  },
  {
    label: 'Events',
    value: 'events',
    description: 'Various affairs taken part in'
  },
  {
    label: 'Long-term projects',
    value: 'projects',
    description: 'Significant undertakings with defined goals and timelines'
  }
])
const activeRole = ref<CheckboxGroupValue[]>(['jobs', 'education', 'projects', 'volunteering', 'events'])

const TagCatItems = ref([
  {
    type: 'label',
    label: 'Fruits',
  },
  {
    type: 'item',
    label: 'Apple',
    icon: 'i-lucide-circle-help'
  },
  {
    type: 'item',
    label: 'Banana',
    icon: 'i-lucide-circle-help'
  },
  {
    type: 'item',
    label: 'Blueberry',
    icon: 'i-lucide-circle-help'
  },
  {
    type: 'item',
    label: 'Grapes',
    icon: 'i-lucide-circle-help'
  },
  {
    type: 'item',
    label: 'Pineapple',
    icon: 'i-lucide-circle-help'
  },
  {
    type: 'separator'
  },
  {
    type: 'label',
    label: 'Vegetables',
  },
  {
    type: 'item',
    label: 'Broccoli',
    icon: 'i-lucide-circle-help'
  },
  {
    type: 'item',
    label: 'Carrot',
    icon: 'i-lucide-circle-help'
  },
  {
    type: 'item',
    label: 'Courgette',
    icon: 'i-lucide-circle-help'
  },
  {
    type: 'item',
    label: 'Leek',
    icon: 'i-lucide-circle-help'
  }
] satisfies InputMenuItem[])
const TagCatValue = ref()

function onInputOpen(open: boolean) {
  if (open) {
    // make popup scrollable
    setTimeout(() => {
      document.querySelectorAll('[data-reka-popper-content-wrapper]')[0].setAttribute("data-lenis-prevent", "");
    }, 100);
  }
}

</script>

<template>
  <contentPanels>
    <template #left-panel-header>
      <div class="font-bold " style="line-height: 1;">
        <MazAnimatedElement direction="up" :duration="700" :delay="500">
          <p class="text-[3rem] varela">Experience</p>
        </MazAnimatedElement>
        <MazAnimatedElement direction="up" :duration="700" :delay="600">
          <p class="text-[1rem]">My professional growth</p>
        </MazAnimatedElement>
      </div>
    </template>

    <template #left-panel-content>
      <MazAnimatedElement direction="up" :duration="700" :delay="700">
        <UCheckboxGroup color="neutral" variant="table" :items="roles"
          v-model="activeRole" legend="Filter by role"
          :default-value="['jobs', 'education', 'projects', 'volunteering', 'events']">
          <template #legend>
            <UButton
              :icon="activeRole?.length! < 3 ? 'i-lucide-check-check' : 'i-lucide-squares-subtract'"
              color="neutral" variant="outline" size="sm"
              @click="activeRole?.length! < 3 ? activeRole = ['jobs', 'education', 'projects', 'volunteering', 'events'] : activeRole = []" />
            <div class="font-bold ml-1 align-text-bottom inline">Filter by role
            </div>
          </template>
        </UCheckboxGroup>
      </MazAnimatedElement>
      <MazAnimatedElement direction="up" :duration="700" :delay="800">
        <UInputMenu v-model="TagCatValue" :items="TagCatItems" multiple
          placeholder="Select for tag cat" variant="soft"
          style="--ui-primary: #4a5565" :icon="TagCatValue?.icon" :ui="{
            trailingIcon: 'group-data-[state=open]:rotate-180 transition-transform duration-200'
          }" data-lenis-prevent class="mx-auto my-4 w-fit block"
          @update:open="onInputOpen">
          <template #tags-item-text="item">
            <UIcon :name="item.item.icon as string" />
            {{ item.item.label }}
          </template>
        </UInputMenu>
      </MazAnimatedElement>
    </template>

    <template #content>
      <TransitionGroup name="list">
        <!-- multiple timelines used instead of one so that items can be transitioned -->
        <UTimeline :default-value="-1" v-for="(role, i) in items" :key="i"
          :items="i == items.length - 1 ? [role] : [role,
            { date: '', title: '', to: '', description: 'empty' }
          ]" class="w-full mt-1 timeline" size="lg" :ui="{
            date: 'float-end ms-1 pr-4',
            description: 'px-3 mr-4 py-2 mt-2 rounded-md text-default cardShadow border border-[var(--ui-border)] bg-white dark:bg-black opacity-80',
            separator: 'cardShadow border border-[var(--ui-border)] bg-white dark:bg-black brightness-200',
            indicator: 'cardShadow border border-[var(--ui-border)] bg-white dark:bg-black opacity-80',
          }">
          <template #date="{ item }">
            <div v-if="item.description == 'empty'" class="hidden"></div>
            <nuxt-link :to="item.to" v-else>
              {{ item.date }}
            </nuxt-link>
          </template>
          <template #title="{ item }">
            <div v-if="item.description == 'empty'" class="hidden">
            </div>
            <nuxt-link :to="item.to" v-else>
              {{ item.title }}
            </nuxt-link>
          </template>
          <template #description="{ item }">
            <div v-if="item.description == 'empty'" class="hidden"></div>
            <nuxt-link v-else :to="item.to">
              <!-- Could use md here -->
              {{ item.description }}
            </nuxt-link>
          </template>
        </UTimeline>
      </TransitionGroup>
    </template>

  </contentPanels>
</template>

<style>
.timeline div:has(.hidden) {
  display: none;
}

.list-enter-active,
.list-leave-active {
  transition: all 1s ease;
}

.list-enter-from,
.list-leave-to {
  opacity: 0;
  transform: translateY(70px);
}
</style>